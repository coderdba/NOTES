=======================================
ISTIO INSTALL ON A KUBERNETES CLUSTER
=======================================
https://istio.io/latest/docs/setup/getting-started/

======
SETUP
======
Single node kubernetes - installed with kubeadm init
Master tainted so that we can use it as worker nodes for non-system pods

==============
ISTIO INSTALL
==============
Logon to a machine that is running Kubernetes

--------------
ISTIO SOFTWARE
--------------
mkdir /root/istio
cd /root/istio

# curl -L https://istio.io/downloadIstio | TARGET_ARCH=x86_64 sh -
          % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                         Dload  Upload   Total   Spent    Left  Speed
        100   102  100   102    0     0     72      0  0:00:01  0:00:01 --:--:--    72
        100  4573  100  4573    0     0   1961      0  0:00:02  0:00:02 --:--:-- 4465k

        Downloading istio-1.10.2 from https://github.com/istio/istio/releases/download/1.10.2/istio-1.10.2-linux-amd64.tar.gz ...

        Istio 1.10.2 Download Complete!

        Istio has been successfully downloaded into the istio-1.10.2 folder on your system.

        Next Steps:
        See https://istio.io/latest/docs/setup/install/ to add Istio to your Kubernetes cluster.

        To configure the istioctl client tool for your workstation,
        add the /root/istio/istio-1.10.2/bin directory to your environment path variable with:
           export PATH="$PATH:/root/istio/istio-1.10.2/bin"

        Begin the Istio pre-installation check by running:
           istioctl x precheck 

        Need more information? Visit https://istio.io/latest/docs/setup/install/ 

This installs istio in a subdirectory:
# ls -l
total 0
drwxr-x---. 6 root root 115 Jun 22 00:58 istio-1.10.2

Move it to /opt directory (optional)
# mv istio* /opt/.

Add /opt/istio-1.10.2/bin to PATH

---------------------
INSTALL ISTIO
---------------------
Run this:
# istioctl install --set profile=demo -y
✔ Istio core installed                                                                                                                                     
✔ Istiod installed                                                                                                                                         
✔ Egress gateways installed                                                                                                                                
✔ Ingress gateways installed                                                                                                                               
✔ Installation complete                                                                                                                                    Thank you for installing Istio 1.10.  Please take a few minutes to tell us about your install/upgrade experience!  https://forms.gle/KjkrDnMPByq7akrYA

-- If error like this comes - stop vpn and ensure proper internet speed
# istioctl install --set profile=demo -y
✔ Istio core installed                                                                                                                                     
✘ Istiod encountered an error: failed to wait for resource: resources not ready after 5m0s: timed out waiting for the condition                            
Deployment/istio-system/istiod
✘ Egress gateways encountered an error: failed to wait for resource: resources not ready after 5m0s: timed out waiting for the conditionsystem/istio-ing...
Deployment/istio-system/istio-egressgateway
✘ Ingress gateways encountered an error: failed to wait for resource: resources not ready after 5m0s: timed out waiting for the condition                  
Deployment/istio-system/istio-ingressgateway
- Pruning removed resources                                                                                                                                Error: failed to install manifests: errors occurred during operation

Issue: https://github.com/istio/istio/issues/22677
         - https://github.com/helm/charts/tree/master/stable/external-dns
         
-----------------------------
ENABLE ISTIO TO INJECT ENVOY
-----------------------------
Add a namespace label to 'default' namespace - to instruct Istio to automatically inject Envoy sidecar proxies when you deploy your application later:

kubectl label namespace default istio-injection=enabled
--> namespace/default labeled

======================================
DEPLOY A SAMPLE APPLICATION
======================================
kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml

