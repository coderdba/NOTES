====================================
EXTERNAL SECRETS
====================================

Reference: https://blog.container-solutions.com/tutorialexternal-secrets-with-hashicorp-vault

Vault CLI: https://developer.hashicorp.com/vault/docs/commands


1. Set up Hashicorp Vault

2. Configure Hashicorp Vault Authentication:

a. Create a policy;
b. Configure Kubernetes authentication endpoint;
c. Create a role;
d. Bind the role to kubernetes authentication endpoint;

3. Configure External-Secrets

=====================================
INSTALL HELM
=====================================
https://phoenixnap.com/kb/install-helm
Download from: https://github.com/helm/helm/releases
Unzip to a folder
Add the folder to PATH

=====================================
Set up Hashicorp Vault
=====================================
This is to setup a hashicorp vault locally on the laptop.

- ADD REPO
helm repo add hashicorp https://helm.releases.hashicorp.com

- INSTALL
helm install vault hashicorp/vault -n vault --create-namespace
  NAME: vault
  LAST DEPLOYED: Tue Nov  8 12:52:33 2022
  NAMESPACE: vault
  STATUS: deployed
  REVISION: 1
  NOTES:
  Thank you for installing HashiCorp Vault!

  Now that you have deployed Vault, you should look over the docs on using
  Vault with Kubernetes available here:

  https://www.vaultproject.io/docs/

  Your release is named vault. To learn more about the release, try:

    $ helm status vault
    $ helm get manifest vault

  C:\Users\GSM078>helm status vault
  Error: release: not found

  C:\Users\GSM078>helm get manifest vault
  Error: release: not found

- VERIFY
kubectl get pods --all-namespaces
NAMESPACE     NAME                                     READY   STATUS    RESTARTS       AGE
kube-system   coredns-78fcd69978-w7fkj                 1/1     Running   0              171m
kube-system   coredns-78fcd69978-xsfk4                 1/1     Running   0              171m
kube-system   etcd-docker-desktop                      1/1     Running   0              171m
kube-system   kube-apiserver-docker-desktop            1/1     Running   0              171m
kube-system   kube-controller-manager-docker-desktop   1/1     Running   0              171m
kube-system   kube-proxy-ctttm                         1/1     Running   0              171m
kube-system   kube-scheduler-docker-desktop            1/1     Running   0              171m
kube-system   storage-provisioner                      1/1     Running   0              170m
kube-system   vpnkit-controller                        1/1     Running   13 (15m ago)   170m
vault         vault-0                                  0/1     Running   0              58s
vault         vault-agent-injector-8fdbb58b6-4l54t     1/1     Running   0              59s

- VERIFY
kubectl get services --all-namespaces
NAMESPACE     NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE
default       kubernetes                 ClusterIP   10.96.0.1       <none>        443/TCP                  3h3m
kube-system   kube-dns                   ClusterIP   10.96.0.10      <none>        53/UDP,53/TCP,9153/TCP   3h3m
vault         vault                      ClusterIP   10.101.9.95     <none>        8200/TCP,8201/TCP        12m
vault         vault-agent-injector-svc   ClusterIP   10.105.167.40   <none>        443/TCP                  12m
vault         vault-internal             ClusterIP   None            <none>        8200/TCP,8201/TCP        12m

======================================
EXPOSE VAULT SERVICE
======================================
After vault is deployed, the next step is to expose its service so we can configure it using vault cli. 
Then, we are going to use vault cli to initialize vault and unseal it

- IN LINUX
export VAULT_ADDR=http://127.0.0.1:8200
kubectl port-forward svc/vault -n vault 8200:8200 &
vault operator init

- IN WINDOWS
set VAULT_ADDR=http://127.0.0.1:8200

-- run in background
start /b kubectl port-forward svc/vault -n vault 8200:8200

C:\Users\GSM078\CODE-MAERSK\git-maersk\gowrish\k8s-certs>Forwarding from 127.0.0.1:8200 -> 8200
Forwarding from [::1]:8200 -> 8200

- INITIALIZE THE VAULT
kubectl exec -n vault vault-0 -- vault operator init
(the reference website says just "vault operator init" - but it should be executed within the vault-0 pod)

  Unseal Key 1: cr/cGy9XZJS7Mhre97+sXJdMDWURJ7f4NrjnMaHmPd5q
  Unseal Key 2: AUJgAEJZU9UN7ajAqB8cUsM1Fm15mzC3CrUQxKGRDQJt
  Unseal Key 3: yZTsU9mLSGJMXUjRCXq3RV4Gf33j/BlZ8A7iZcSs3sPQ
  Unseal Key 4: 8TUKW2PEoctCxJy4KImzJFxGx/gi5GFaVO2su8c8QbYs
  Unseal Key 5: qCg1OGJitNBL/v7sAbs+F1D4R3Zn+x1MlYpZxdSq/ikk

  Initial Root Token: hvs.vCiWcDmKMb2z5C7JR2LCruC2

  Vault initialized with 5 key shares and a key threshold of 3. Please securely
  distribute the key shares printed above. When the Vault is re-sealed,
  restarted, or stopped, you must supply at least 3 of these keys to unseal it
  before it can start servicing requests.

  Vault does not store the generated root key. Without at least 3 keys to
  reconstruct the root key, Vault will remain permanently sealed!

  It is possible to generate new unseal keys, provided you have a quorum of
  existing unseal keys shares. See "vault operator rekey" for more information.

- UNSEAL THE VAULT
vault operator unseal <key 1>
vault operator unseal <key 2>
vault operator unseal <key 3>

kubectl exec -n vault vault-0 -- vault operator unseal cr/cGy9XZJS7Mhre97+sXJdMDWURJ7f4NrjnMaHmPd5q
  Key                Value
  ---                -----
  Seal Type          shamir
  Initialized        true
  Sealed             true
  Total Shares       5
  Threshold          3
  Unseal Progress    1/3
  Unseal Nonce       40413a31-59e7-ca4f-a672-0b2a0181d716
  Version            1.12.0
  Build Date         2022-10-10T18:14:33Z
  Storage Type       file
  HA Enabled         false

kubectl exec -n vault vault-0 -- vault operator unseal AUJgAEJZU9UN7ajAqB8cUsM1Fm15mzC3CrUQxKGRDQJt
  Key                Value
  ---                -----
  Seal Type          shamir
  Initialized        true
  Sealed             true
  Total Shares       5
  Threshold          3
  Unseal Progress    2/3
  Unseal Nonce       40413a31-59e7-ca4f-a672-0b2a0181d716
  Version            1.12.0
  Build Date         2022-10-10T18:14:33Z
  Storage Type       file
  HA Enabled         false

kubectl exec -n vault vault-0 -- vault operator unseal yZTsU9mLSGJMXUjRCXq3RV4Gf33j/BlZ8A7iZcSs3sPQ
  Key             Value
  ---             -----
  Seal Type       shamir
  Initialized     true
  Sealed          false
  Total Shares    5
  Threshold       3
  Version         1.12.0
  Build Date      2022-10-10T18:14:33Z
  Storage Type    file
  Cluster Name    vault-cluster-3971059c
  Cluster ID      4fcccdce-d871-ed89-fbc7-49bdcaa92c36
  HA Enabled      false

- LOGIN TO VAULT
kubectl exec -n vault vault-0 -- vault login hvs.vCiWcDmKMb2z5C7JR2LCruC2

  Success! You are now authenticated. The token information displayed below
  is already stored in the token helper. You do NOT need to run "vault login"
  again. Future Vault requests will automatically use this token.

  Key                  Value
  ---                  -----
  token                hvs.vCiWcDmKMb2z5C7JR2LCruC2
  token_accessor       AVZtQJVJXSnxOpRORonV9oH6
  token_duration       âˆž
  token_renewable      false
  token_policies       ["root"]
  identity_policies    []
  policies             ["root"]

